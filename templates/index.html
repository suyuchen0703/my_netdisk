<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„äº‘ç›˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .header { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 2rem; font-weight: 600; }
        .upload-btn { background: #fff; color: #4facfe; border: none; padding: 12px 25px; border-radius: 30px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); }
        #fileInput { display: none; }
        .file-list { padding: 30px; }
        .file-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .file-count { color: #666; font-size: 1.1rem; }
        .file-item { display: flex; align-items: center; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 10px; transition: all 0.3s ease; border-left: 4px solid #4facfe; }
        .file-item:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .thumbnail { width: 60px; height: 60px; border-radius: 8px; overflow: hidden; margin-right: 20px; background: #ddd; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .thumbnail .file-icon { font-size: 24px; color: #666; }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-weight: 600; color: #333; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-details { display: flex; gap: 15px; color: #666; font-size: 0.9rem; }
        .action-btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; }
        .download-btn { background: #4facfe; color: white; }
        .delete-btn { background: #ff6b6b; color: white; }
        .action-btn:hover { opacity: 0.8; transform: scale(1.05); }
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: rgba(255, 255, 255, 0.3); z-index: 1000; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #4facfe, #00f2fe); width: 0%; transition: width 0.3s ease; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { max-width: 90%; max-height: 90%; }
        .modal-content img, .modal-content video { max-width: 100%; max-height: 80vh; border-radius: 10px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; transition: color 0.3s ease; }
        .close-modal:hover { color: #4facfe; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .header h1 { font-size: 1.5rem; }
            .file-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .file-actions { align-self: flex-end; }
        }
    </style>
</head>
<body>
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ“ æˆ‘çš„äº‘ç›˜</h1>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</button>
            <input type="file" id="fileInput" multiple accept="image/*,video/*" onchange="handleFileUpload(event)">
        </div>

        <div class="file-list">
            <div class="file-list-header">
                <div class="file-count" id="fileCount">å…± 0 ä¸ªæ–‡ä»¶</div>
            </div>
            <div id="fileList">
                <div class="empty-state" id="emptyState">
                    <div>â˜ï¸</div>
                    <p>æš‚æ— æ–‡ä»¶ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ </p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="previewModal" onclick="closePreview()">
        <span class="close-modal">&times;</span>
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–åç«¯çš„æ–‡ä»¶åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            renderFileList();
        });

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨åç«¯ä¼ é€’çš„filesæ•°æ®ï¼‰
        function renderFileList() {
            const fileListElement = document.getElementById('fileList');
            const fileCountElement = document.getElementById('fileCount');
            const emptyState = document.getElementById('emptyState');

            // ä»Flaskæ¨¡æ¿è·å–æ–‡ä»¶åˆ—è¡¨
            const files = window.fileData || [];
            fileCountElement.textContent = `å…± ${files.length} ä¸ªæ–‡ä»¶`;

            if (files.length === 0) {
                emptyState.style.display = 'block';
                fileListElement.innerHTML = '';
                fileListElement.appendChild(emptyState);
                return;
            }

            emptyState.style.display = 'none';
            fileListElement.innerHTML = '';

            files.forEach(file => {
                const fileUrl = `/files/${encodeURIComponent(file.name)}`;
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="thumbnail" onclick="previewFile('${file.name}', '${file.type}')">
                        ${file.type === 'image'
                            ? `<img src="${fileUrl}" alt="${file.name}">`
                            : `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23666' d='M8 5v14l11-7z'/%3E%3C/svg%3E" alt="è§†é¢‘ç¼©ç•¥å›¾">`}
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-details">
                            <span>ğŸ’¾ ${file.size} MB</span>
                            <span>${file.type === 'image' ? 'ğŸ–¼ï¸ å›¾ç‰‡' : 'ğŸ¬ è§†é¢‘'}</span>
                            <span>ğŸ•’ ${file.mtime}</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn download-btn" onclick="downloadFile('${file.name}')">ğŸ“¥ ä¸‹è½½</button>
                        <button class="action-btn delete-btn" onclick="deleteFile('${file.name}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                `;
                fileListElement.appendChild(fileItem);
            });
        }

        // ä¸Šä¼ æ–‡ä»¶ï¼ˆå¯¹æ¥åç«¯æ¥å£ï¼‰
        async function handleFileUpload(event) {
            const selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length === 0) return;

            showProgress();
            let successCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    updateProgress(((i + 1) / selectedFiles.length) * 100);
                    const res = await fetch('/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.success) successCount++;
                    else alert(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥ï¼š${data.msg}`);
                } catch (err) {
                    alert(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥ï¼š${err.message}`);
                }
            }

            hideProgress();
            event.target.value = '';
            if (successCount > 0) {
                alert(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶ï¼`);
                window.location.reload(); // åˆ·æ–°é¡µé¢åŠ è½½æ–°æ–‡ä»¶
            }
        }

        // é¢„è§ˆæ–‡ä»¶
        function previewFile(filename, fileType) {
            const modal = document.getElementById('previewModal');
            const modalContent = document.getElementById('modalContent');
            const fileUrl = `/files/${encodeURIComponent(filename)}`;

            if (fileType === 'image') {
                modalContent.innerHTML = `<img src="${fileUrl}" alt="${filename}">`;
            } else if (fileType === 'video') {
                modalContent.innerHTML = `<video controls autoplay><source src="${fileUrl}" type="video/mp4">æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾</video>`;
            } else {
                alert('ä¸æ”¯æŒé¢„è§ˆ');
                return;
            }
            modal.style.display = 'flex';
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(filename) {
            window.open(`/download/${encodeURIComponent(filename)}`, '_blank');
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(filename) {
            if (!confirm(`ç¡®å®šåˆ é™¤ "${filename}" å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(`/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    window.location.reload();
                } else {
                    alert(`åˆ é™¤å¤±è´¥ï¼š${data.msg}`);
                }
            } catch (err) {
                alert(`åˆ é™¤å¤±è´¥ï¼š${err.message}`);
            }
        }

        // è¿›åº¦æ¡æ§åˆ¶
        function showProgress() { document.getElementById('progressContainer').style.display = 'block'; }
        function hideProgress() { setTimeout(() => { document.getElementById('progressContainer').style.display = 'none'; document.getElementById('progressBar').style.width = '0%'; }, 500); }
        function updateProgress(percent) { document.getElementById('progressBar').style.width = percent + '%'; }

        // é”®ç›˜å…³é—­é¢„è§ˆ
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closePreview(); });
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('previewModal').addEventListener('click', e => { if (e.target === this) closePreview(); });

        // æŠŠFlaskä¼ é€’çš„filesæ•°æ®èµ‹å€¼ç»™å‰ç«¯å˜é‡
        {% if files %}
            window.fileData = {{ files|tojson }};
        {% else %}
            window.fileData = [];
        {% endif %}
    </script>
</body>
</html>